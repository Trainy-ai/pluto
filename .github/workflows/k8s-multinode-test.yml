name: k8s-multinode-test

on:
  push:
    branches:
      - main
      - 'releases/**'
  pull_request:
    branches:
      - main
      - 'releases/**'
  workflow_dispatch:

jobs:
  k8s-multinode-test:
    # Use ubicloud runner for better performance and cost
    runs-on: ubicloud-standard-8
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.24.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Install konduktor CLI
        run: |
          pip install konduktor-nightly
          konduktor --version || echo "konduktor installed"

      - name: Run k8s multinode E2E test
        env:
          PLUTO_API_TOKEN: ${{ secrets.MLOP_API_TOKEN }}
          PLUTO_DEBUG_LEVEL: DEBUG
        run: |
          set -euox pipefail
          bash tests/k8s/run_multinode_test.sh 2>&1 | tee k8s_multinode_test.log

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k8s-multinode-test-logs
          path: k8s_multinode_test.log
          retention-days: 7

# Konduktor job definition for multinode E2E test
# This demonstrates how to use konduktor to launch a distributed training job
# where all nodes share the same PLUTO_RUN_ID and log to the same Pluto run.
#
# Launch with: konduktor launch tests/k8s/multinode-job.yaml
#
# Environment variables that konduktor injects:
# - $MASTER_ADDR: Address of the master node (for torchrun rendezvous)
# - $NUM_NODES: Total number of nodes in the job
# - $RANK: Global rank of this node (0, 1, 2, ...)
# - $SKYPILOT_NODE_RANK: Same as RANK (for compatibility)

name: pluto-multinode-e2e-test
num_nodes: 2

resources:
  cpus: 2
  memory: 4
  cloud: kubernetes
  image_id: pluto-multinode-test:latest
  labels:
    kueue.x-k8s.io/queue-name: user-queue

# Environment variables for Pluto
envs:
  PLUTO_PROJECT: testing-ci
  # PLUTO_RUN_ID and PLUTO_API_TOKEN should be set before launching
  # or passed via: konduktor launch --env PLUTO_RUN_ID=xxx --env PLUTO_API_TOKEN=xxx

setup: |
  # Install pluto if not in image
  pip install pluto-ml || true

run: |
  set -e

  echo "[Node $RANK] Starting multinode E2E test"
  echo "[Node $RANK] MASTER_ADDR=$MASTER_ADDR"
  echo "[Node $RANK] NUM_NODES=$NUM_NODES"
  echo "[Node $RANK] PLUTO_RUN_ID=$PLUTO_RUN_ID"

  # Run the multinode worker script
  python /workspace/multinode_worker.py

  echo "[Node $RANK] Test completed!"

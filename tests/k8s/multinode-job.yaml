# Konduktor job definition for multinode E2E test
# Based on the konduktor CI pattern for distributed training
#
# Launch with: konduktor launch tests/k8s/multinode-job.yaml
#
# Prerequisites:
# - JobSet controller installed
# - Kueue installed
# - LocalQueue 'user-queue' created
#
# Environment variables injected by konduktor:
# - $MASTER_ADDR: Address of the master node
# - $NUM_NODES: Total number of nodes
# - $RANK: Global rank of this node (0, 1, ...)
# - $RDZV_CONF: Rendezvous configuration for torchrun

name: pluto-multinode-e2e-test
num_nodes: 2

resources:
  cpus: 1
  memory: 2
  image_id: pluto-multinode-test:local
  labels:
    kueue.x-k8s.io/queue-name: user-queue
    maxRunDurationSeconds: "3200"

run: |
  set -e
  echo "[Node $RANK] Starting multinode test"
  echo "[Node $RANK] MASTER_ADDR=$MASTER_ADDR"
  echo "[Node $RANK] NUM_NODES=$NUM_NODES"
  echo "[Node $RANK] PLUTO_RUN_ID=$PLUTO_RUN_ID"

  torchrun \
    --rdzv_id=123 \
    --nnodes=$NUM_NODES \
    --nproc_per_node=1 \
    --master_addr=$MASTER_ADDR \
    --master_port=1234 \
    --node_rank=$RANK \
    --rdzv_conf=$RDZV_CONF \
    /workspace/multinode_worker.py

  echo "[Node $RANK] Test completed!"

name: Neptune Compatibility Tests

# This workflow tests the Neptune-to-mlop compatibility layer during the migration period
# It ensures that:
# 1. Neptune API calls continue to work unchanged
# 2. Dual-logging to mlop works when configured
# 3. Fallback behavior is correct when mlop fails
# 4. No breaking changes are introduced during the 2-month transition

on:
  push:
    branches:
      - main
      - 'releases/**'
  pull_request:
    branches:
      - main
      - 'releases/**'
  workflow_dispatch:
  # Run daily during the 2-month transition period
  schedule:
    - cron: '0 8 * * *'  # Run at 8 AM UTC daily

jobs:
  neptune-compatibility:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
        poetry-version: ["2.1.1"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: "Setup Python, Poetry and Dependencies"
        uses: packetcoders/action-setup-cache-python-poetry@main
        with:
          python-version: ${{ matrix.python-version }}
          poetry-version: ${{ matrix.poetry-version }}
          install-args: "--with dev"

      - name: Install dependencies including neptune-scale
        run: |
          set -euox pipefail
          poetry install --with dev --extras full
          # Verify neptune-scale is installed
          poetry run python -c "import neptune_scale; print(f'neptune-scale version: {neptune_scale.__version__}')"

      - name: Run Neptune compatibility tests (without mlop config)
        run: |
          set -euox pipefail
          # Test that Neptune works normally without mlop configuration
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneCompatBasic -v -rs
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneCompatAPIForwarding -v -rs
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneCompatFallbackBehavior -v -rs

      - name: Run Neptune error handling tests
        run: |
          set -euox pipefail
          # Test that Neptune never fails due to mlop errors
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneCompatErrorHandling -v -rs

      - name: Run Neptune file conversion tests
        run: |
          set -euox pipefail
          # Test file type conversion
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneCompatFileConversion -v -rs

      - name: Run real Neptune integration tests
        env:
          NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_API_TOKEN }}
          NEPTUNE_PROJECT: "asai/test"
        run: |
          set -euox pipefail
          # Test with real Neptune client (without mlop)
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneRealBackend::test_real_neptune_without_mlop -v -rs || echo "Real Neptune tests skipped (credentials not configured)"
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneRealBackend::test_real_neptune_context_manager -v -rs || echo "Real Neptune context manager tests skipped (credentials not configured)"

      - name: Setup mlop credentials for dual-logging tests
        env:
          MLOP_API_TOKEN: ${{ secrets.MLOP_API_TOKEN }}
        run: |
          set -euox pipefail
          mlop login "${MLOP_API_TOKEN}" || echo "mlop login failed, dual-logging tests will be skipped"

      - name: Run Neptune dual-logging integration tests
        env:
          NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_API_TOKEN }}
          NEPTUNE_PROJECT: "asai/test"
          MLOP_PROJECT: "testing-ci"
          CI: "true"
        run: |
          set -euox pipefail
          # Test dual-logging to both Neptune (mock) and mlop (real)
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneCompatDualLogging -v -rs || echo "Dual-logging tests skipped (mlop not configured)"
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneCompatIntegration -v -rs || echo "Integration tests skipped (mlop not configured)"
          # Test full dual-logging with both real Neptune and mlop
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneRealBackend::test_real_neptune_with_mlop_dual_logging -v -rs || echo "Full dual-logging tests skipped (credentials not configured)"
          poetry run pytest tests/test_neptune_compat.py::TestNeptuneRealBackend::test_real_neptune_mlop_resilience -v -rs || echo "Resilience tests skipped (credentials not configured)"

      - name: Report test results
        if: always()
        run: |
          echo "Neptune compatibility tests completed"
          echo "Python version: ${{ matrix.python-version }}"
          echo "Status: ${{ job.status }}"

  neptune-migration-examples:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
        poetry-version: ["2.1.1"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: "Setup Python, Poetry and Dependencies"
        uses: packetcoders/action-setup-cache-python-poetry@main
        with:
          python-version: ${{ matrix.python-version }}
          poetry-version: ${{ matrix.poetry-version }}
          install-args: "--with dev"

      - name: Install dependencies
        run: |
          set -euox pipefail
          poetry install --with dev --extras full
          pip install -e ".[dev,full]"

      - name: Validate migration example scripts
        run: |
          set -euox pipefail
          # Validate that example scripts have correct syntax
          python -m py_compile examples/neptune_migration_example.py
          echo "✓ Migration example scripts are valid"

      - name: Validate migration documentation
        run: |
          set -euox pipefail
          # Check that documentation exists and has required sections
          test -f examples/neptune_migration_README.md
          grep -q "Quick Start" examples/neptune_migration_README.md
          grep -q "Configuration Options" examples/neptune_migration_README.md
          grep -q "Supported Neptune Features" examples/neptune_migration_README.md
          echo "✓ Migration documentation is complete"

  # This job serves as a status check gate
  neptune-compat-status:
    runs-on: ubuntu-latest
    needs: [neptune-compatibility, neptune-migration-examples]
    if: always()
    steps:
      - name: Check test status
        run: |
          if [ "${{ needs.neptune-compatibility.result }}" != "success" ]; then
            echo "❌ Neptune compatibility tests failed"
            exit 1
          fi
          if [ "${{ needs.neptune-migration-examples.result }}" != "success" ]; then
            echo "❌ Neptune migration examples validation failed"
            exit 1
          fi
          echo "✅ All Neptune compatibility checks passed"
